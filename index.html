<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>北海道旅程 (精緻雲端同步版)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'hokkaido-dark': '#0c4a6e', // 更深的沉靜藍
                        'hokkaido-main': '#3b82f6',
                        'hokkaido-light': '#dbeafe',
                        'hokkaido-bg': '#f3f6fb',    // 淺藍雪地背景
                        'accent': '#f43f5e',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.3s ease-out',
                    }
                }
            }
        }
    </script>
    <!-- FontAwesome & Leaflet (地圖) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* 基本樣式與捲軸隱藏 */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* 讓 App 佔滿容器高度 */
        body { background-color: #e2e8f0; display: flex; justify-content: center; min-height: 100vh; margin: 0; }
        #app-container { width: 100%; max-width: 430px; background-color: #f3f6fb; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        /* 玻璃擬態導航欄 */
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.3); }
        #map { height: 100%; width: 100%; z-index: 0; }
        
        /* 讀取畫面優化 */
        .loading-overlay { 
            position: absolute; 
            inset: 0; 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(8px); 
            z-index: 999; 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center;
        }

        /* 行程卡片視覺調整：時間軸效果 */
        .timeline-item {
            position: relative;
            padding-left: 20px; /* 留給時間軸線的空間 */
        }
        .timeline-item:before {
            content: '';
            position: absolute;
            top: 0;
            left: 5px; /* 線的位置 */
            width: 2px;
            height: 100%;
            background-color: #dbeafe; /* 冰晶淺藍線 */
            z-index: 10;
        }
        .timeline-item:last-child:before {
            height: 50%; /* 最後一個項目線條只到一半 */
        }
        .timeline-dot {
            position: absolute;
            top: 24px; /* 讓圓點對齊卡片中間偏上 */
            left: 0;
            width: 12px;
            height: 12px;
            background-color: #0c4a6e; /* 深藍圓點 */
            border-radius: 50%;
            border: 3px solid #f3f6fb; /* 突出圓點 */
            z-index: 20;
        }
        
    </style>
</head>
<body>

<div id="app" class="w-full flex justify-center h-full">
    <div id="app-container">
        
        <!-- 讀取畫面 -->
        <div v-if="loading" class="loading-overlay">
            <div class="text-center p-8 bg-white rounded-xl shadow-2xl">
                <i class="fa-solid fa-cloud-arrow-down fa-bounce text-4xl mb-4 text-hokkaido-main"></i>
                <p class="text-lg text-hokkaido-dark font-bold">雲端同步中...</p>
                <p class="text-xs text-gray-400 mt-1">首次開啟可能稍久，請稍候</p>
                <p v-if="!dbInitialized" class="text-xs text-red-500 mt-2">正在等待 Firebase 初始化...</p>
            </div>
        </div>

        <!-- 頂部 Header: 日期與標題 -->
        <header class="bg-white pt-12 pb-2 px-4 shadow-md z-20 flex-shrink-0">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold text-hokkaido-dark tracking-wider">HOKKAIDO <span class="text-xs font-normal block" :class="loading ? 'text-gray-400' : 'text-green-500'"><i class="fa-solid fa-cloud" :class="{'fa-bounce': loading, 'text-green-500': !loading}"></i> 雲端狀態</span></h1>
                <div class="text-right">
                    <span class="text-xs text-gray-400">當前匯率</span>
                    <div @click="editRate" class="font-bold text-hokkaido-main text-sm cursor-pointer border-b border-dashed border-blue-300">1 JPY = {{ exchangeRate }} TWD</div>
                </div>
            </div>

            <!-- 橫向滑動日期選單 -->
            <div class="flex space-x-3 overflow-x-auto hide-scrollbar pb-2">
                <div v-for="(day, index) in days" :key="index" 
                     @click="selectDay(index)"
                     class="flex-shrink-0 flex flex-col items-center justify-center w-16 h-18 rounded-xl p-2 transition-all duration-300 cursor-pointer shadow-sm border"
                     :class="currentDay === index ? 'bg-hokkaido-dark text-white shadow-xl border-hokkaido-dark transform scale-105' : 'bg-white text-gray-500 border-gray-100'">
                    <span class="text-xs font-medium">{{ day.weekday }}</span>
                    <span class="text-2xl font-bold">{{ day.date.split('/')[1] }}</span>
                    <span class="text-xs">{{ day.date.split('/')[0] }}月</span>
                </div>
            </div>
        </header>

        <!-- 主要內容區 -->
        <main class="flex-1 overflow-y-auto hide-scrollbar bg-hokkaido-bg relative">
            
            <!-- 1. 行程表 Tab -->
            <div v-if="currentTab === 'schedule'" class="p-4 space-y-4 pb-24">
                
                <!-- 總覽天氣卡 -->
                <div class="bg-gradient-to-r from-hokkaido-main to-hokkaido-dark rounded-3xl p-5 text-white shadow-lg relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 text-8xl opacity-10 text-white"><i class="fa-solid fa-mountain-sun"></i></div>
                    <div class="flex justify-between items-end relative z-10">
                        <div>
                            <p class="opacity-80 text-sm">今日主題</p>
                            <h2 class="text-3xl font-bold mt-1">{{ days[currentDay].weekday }}</h2>
                            <p class="text-sm mt-2 opacity-90">行程 {{ currentItinerary.length }} 個地點</p>
                        </div>
                        <div class="text-right">
                            <div class="text-4xl font-light">-2°<span class="text-lg">C</span></div>
                            <div class="text-sm opacity-80">札幌區域</div>
                        </div>
                    </div>
                </div>

                <!-- 行程列表 - Timeline 視覺化 -->
                <div class="space-y-2">
                    <div class="flex justify-between items-center pt-2">
                        <h3 class="font-bold text-gray-700">本日行程</h3>
                        <button @click="showAddModal = true" class="w-8 h-8 rounded-full bg-hokkaido-main text-white shadow-md flex items-center justify-center"><i class="fa-solid fa-plus"></i></button>
                    </div>

                    <div v-if="currentItinerary.length === 0" class="text-center py-10 text-gray-400 bg-white rounded-2xl">
                        <i class="fa-regular fa-calendar-xmark text-4xl mb-2"></i>
                        <p>今天還沒有安排行程喔</p>
                    </div>

                    <div v-for="(item, idx) in currentItinerary" :key="idx" class="timeline-item group transition-all animate-fade-in-up" :style="{'animation-delay': `${idx * 0.05}s`}">
                        
                        <div class="timeline-dot"></div>

                        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 flex gap-4">
                            
                            <!-- 時間區塊 -->
                            <div class="flex flex-col items-center flex-shrink-0 w-16">
                                <span class="text-xl font-extrabold text-hokkaido-dark">{{ item.time.split(':')[0] }}</span>
                                <span class="text-xs text-gray-500 mt-0.5">{{ item.time.split(':')[1] }}</span>
                            </div>

                            <!-- 內容與操作 -->
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <h4 class="font-bold text-gray-800 text-lg">{{ item.location }}</h4>
                                    <!-- 天氣小標籤 -->
                                    <span class="text-xs bg-blue-50 text-blue-500 px-2 py-1 rounded-full flex items-center gap-1">
                                        <i class="fa-solid fa-snowflake"></i> -3°C
                                    </span>
                                </div>
                                <p class="text-gray-500 text-sm mt-1" v-if="item.note">{{ item.note }}</p>
                                
                                <div class="mt-2 flex justify-end">
                                    <button @click="deleteItem(idx)" class="text-xs text-red-400 px-2 py-1 hover:bg-red-50 rounded">刪除</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. 地圖 Tab -->
            <div v-show="currentTab === 'map'" class="h-full w-full relative">
                <div id="map"></div>
                <div class="absolute bottom-24 left-4 right-4 bg-white/90 backdrop-blur rounded-xl p-3 shadow-lg z-[400] flex items-center gap-3">
                    <p class="text-sm text-gray-600">地圖會自動標示當日行程地點</p>
                     <button @click="locateUser" class="bg-hokkaido-dark text-white px-3 py-1.5 rounded-lg text-xs shadow-md ml-auto">我的位置</button>
                </div>
            </div>

            <!-- 3. 記帳 Tab (優化金融介面感) -->
            <div v-if="currentTab === 'wallet'" class="p-4 pb-24 space-y-6">
                
                <!-- 匯率轉換器 -->
                <div class="bg-white p-5 rounded-3xl shadow-lg border-l-4 border-hokkaido-main">
                    <h3 class="text-gray-500 text-sm mb-4 font-medium flex justify-between">
                        <span>日幣換算台幣</span>
                        <span @click="editRate" class="text-hokkaido-main cursor-pointer text-xs"><i class="fa-solid fa-gear"></i> 設定匯率</span>
                    </h3>
                    <div class="flex items-center gap-3 bg-gray-50 p-3 rounded-xl">
                        <div class="relative flex-1">
                            <span class="absolute left-3 top-0 text-gray-400 text-xs">JPY</span>
                            <input type="number" v-model="calcJpy" class="w-full bg-transparent pt-3 pb-0 text-2xl font-bold text-gray-800 outline-none" placeholder="0">
                        </div>
                        <i class="fa-solid fa-arrow-right text-hokkaido-dark text-xl"></i>
                        <div class="relative flex-1">
                            <span class="absolute left-3 top-0 text-hokkaido-dark text-xs font-bold">TWD</span>
                            <div class="w-full bg-transparent pt-3 pb-0 text-2xl font-bold text-hokkaido-dark">
                                {{ (calcJpy * exchangeRate).toFixed(0) }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 總支出卡片 -->
                <div class="bg-hokkaido-dark p-5 rounded-3xl text-white shadow-xl flex justify-between items-center">
                    <div>
                        <p class="opacity-80 text-sm">總支出 (約)</p>
                        <p class="text-4xl font-extrabold mt-1">NT$ {{ totalSpentTwd }}</p>
                    </div>
                    <i class="fa-solid fa-coins text-4xl opacity-50"></i>
                </div>

                <!-- 新增消費 -->
                <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                    <h3 class="font-bold text-gray-800 mb-4">記一筆</h3>
                    <div class="space-y-3">
                        <input v-model="newExpense.item" type="text" placeholder="買了什麼？" class="w-full bg-gray-50 rounded-lg p-3 outline-none focus:ring-1 ring-hokkaido-main transition">
                        <div class="flex gap-2">
                            <input v-model="newExpense.amount" type="number" placeholder="日幣金額" class="flex-1 bg-gray-50 rounded-lg p-3 outline-none focus:ring-1 ring-hokkaido-main transition">
                            <button @click="addExpense" class="bg-hokkaido-main text-white px-6 rounded-xl font-bold shadow-md transform active:scale-95 transition">紀錄</button>
                        </div>
                    </div>
                </div>

                <!-- 消費列表 -->
                <div>
                    <div class="space-y-2">
                        <div v-for="(exp, idx) in expenses" :key="idx" class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm animate-fade-in-up" :style="{'animation-delay': `${idx * 0.05}s`}">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-blue-100 text-hokkaido-dark flex items-center justify-center text-xs flex-shrink-0">
                                    <i class="fa-solid fa-yen-sign"></i>
                                </div>
                                <span class="text-gray-700 font-medium">{{ exp.item }}</span>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-gray-800">¥{{ exp.amount }}</div>
                                <div class="text-xs text-gray-400">≈ NT$ {{ (exp.amount * exchangeRate).toFixed(0) }}</div>
                            </div>
                            <button @click="removeExpense(idx)" class="text-gray-300 hover:text-red-400 ml-2"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. 備用景點 Tab -->
            <div v-if="currentTab === 'backup'" class="p-4 pb-24">
                <h3 class="font-bold text-gray-800 text-xl mb-4">備用口袋名單</h3>
                <div class="bg-white rounded-2xl p-4 shadow-sm mb-4">
                    <div class="flex gap-2">
                        <input v-model="newBackup" @keyup.enter="addBackup" type="text" placeholder="輸入想去的地方..." class="flex-1 bg-gray-50 rounded-lg px-3 py-2 outline-none">
                        <button @click="addBackup" class="bg-hokkaido-main text-white px-4 py-2 rounded-lg font-bold">新增</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div v-for="(spot, idx) in backupSpots" :key="idx" class="bg-white p-3 rounded-xl shadow-sm border border-gray-100 relative group">
                        <button @click="removeBackup(idx)" class="absolute top-1 right-2 text-gray-300 hover:text-red-400"><i class="fa-solid fa-times"></i></button>
                        <p class="font-bold text-gray-800 text-sm truncate">{{ spot }}</p>
                        <button class="text-xs text-hokkaido-main mt-1 w-full text-left">
                            <i class="fa-regular fa-copy"></i> 點擊複製地點
                        </button>
                    </div>
                </div>
            </div>

        </main>

        <!-- 底部導航欄 (玻璃擬態) -->
        <nav class="glass-nav absolute bottom-0 w-full pb-6 pt-3 px-6 flex justify-between items-center z-50 text-gray-400">
            <button @click="switchTab('schedule')" class="flex flex-col items-center gap-1 transition-colors" :class="currentTab === 'schedule' ? 'text-hokkaido-dark' : 'text-gray-400'">
                <i class="fa-solid fa-list-check text-xl"></i>
                <span class="text-[10px]">行程</span>
            </button>
            <button @click="switchTab('map')" class="flex flex-col items-center gap-1 transition-colors" :class="currentTab === 'map' ? 'text-hokkaido-dark' : 'text-gray-400'">
                <i class="fa-solid fa-map-location-dot text-xl"></i>
                <span class="text-[10px]">地圖</span>
            </button>
            
            <!-- 中央浮動按鈕 -->
            <div class="relative -top-6">
                <button @click="showAddModal = true" class="w-14 h-14 bg-hokkaido-main rounded-full shadow-xl shadow-blue-500/30 text-white flex items-center justify-center text-xl transform hover:scale-105 transition">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <button @click="switchTab('wallet')" class="flex flex-col items-center gap-1 transition-colors" :class="currentTab === 'wallet' ? 'text-hokkaido-dark' : 'text-gray-400'">
                <i class="fa-solid fa-wallet text-xl"></i>
                <span class="text-[10px]">記帳</span>
            </button>
            <button @click="switchTab('backup')" class="flex flex-col items-center gap-1 transition-colors" :class="currentTab === 'backup' ? 'text-hokkaido-dark' : 'text-gray-400'">
                <i class="fa-regular fa-bookmark text-xl"></i>
                <span class="text-[10px]">收藏</span>
            </button>
        </nav>

        <!-- 新增行程 Modal -->
        <div v-if="showAddModal" class="absolute inset-0 z-[500] bg-black/50 backdrop-blur-sm flex items-end justify-center animate-fade-in-up">
            <div class="bg-white w-full rounded-t-3xl p-6 shadow-2xl">
                <h3 class="font-bold text-xl mb-4 text-hokkaido-dark">新增行程</h3>
                
                <div class="space-y-4">
                    <input v-model="newItem.time" type="time" class="w-full bg-gray-100 p-3 rounded-xl outline-none border border-transparent focus:border-hokkaido-main">
                    <input v-model="newItem.location" type="text" placeholder="地點，例如：小樽運河" class="w-full bg-gray-100 p-3 rounded-xl outline-none border border-transparent focus:border-hokkaido-main">
                    <textarea v-model="newItem.note" rows="2" placeholder="備註..." class="w-full bg-gray-100 p-3 rounded-xl outline-none resize-none border border-transparent focus:border-hokkaido-main"></textarea>
                </div>

                <div class="flex gap-3 mt-6">
                    <button @click="showAddModal = false" class="flex-1 py-3 rounded-xl bg-gray-200 text-gray-600 font-bold">取消</button>
                    <button @click="addItem" class="flex-1 py-3 rounded-xl bg-hokkaido-dark text-white font-bold shadow-lg shadow-blue-900/20">確認新增</button>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Vue & Firebase Logic -->
<script type="module">
    import { createApp, ref, computed, nextTick } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    // Firebase SDK 導入
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ----------------------------------------------------
    // Canvas 環境變數取得 (確保認證和路徑正確)
    // ----------------------------------------------------
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // Firebase initialization and Auth
    let app, db, auth;
    let dbInitialized = ref(false); // 追蹤 DB 是否初始化成功
    let docRef = null;

    if (firebaseConfig) {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            dbInitialized.value = true;
            
            // 公共路徑: /artifacts/{appId}/public/data/trips/{docId}
            const TRIP_DOC_ID = "hokkaido_trip_2025_shared"; 
            docRef = doc(db, "artifacts", appId, "public", "data", "trips", TRIP_DOC_ID);
            
            // Asynchronously sign in (Anonymous or Custom Token)
            (async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    console.log("Firebase 認證成功 (已登入)。");
                } catch (error) {
                    console.error("Firebase 認證失敗:", error);
                }
            })();
        } catch (e) {
            console.error("錯誤：Firebase 初始化失敗", e);
            dbInitialized.value = false;
        }
    } else {
        console.error("錯誤：缺少 Firebase 配置資訊。App 將無法同步資料。");
    }

    // ----------------------------------------------------

    createApp({
        setup() {
            const loading = ref(true);
            const currentTab = ref('schedule');
            const currentDay = ref(0);
            const showAddModal = ref(false);
            const exchangeRate = ref(0.21); // 預設匯率
            const calcJpy = ref('');
            const mapInstance = ref(null);
            const markers = ref([]);
            
            // 資料結構 (會同步的)
            const itineraryData = ref({});
            const expenses = ref([]);
            const backupSpots = ref([]);

            const days = [
                { weekday: 'Mon', date: '12/23', fullDate: '2024-12-23' },
                { weekday: 'Tue', date: '12/24', fullDate: '2024-12-24' },
                { weekday: 'Wed', date: '12/25', fullDate: '2024-12-25' },
                { weekday: 'Thu', date: '12/26', fullDate: '2024-12-26' },
                { weekday: 'Fri', date: '12/27', fullDate: '2024-12-27' },
                { weekday: 'Sat', date: '12/28', fullDate: '2024-12-28' },
                { weekday: 'Sun', date: '12/29', fullDate: '2024-12-29' },
            ];

            const newItem = ref({ time: '10:00', location: '', note: '' });
            const newExpense = ref({ item: '', amount: '' });
            const newBackup = ref('');

            // --- Firebase 監聽 ---
            if (docRef) {
                onSnapshot(docRef, (docSnap) => {
                    loading.value = false;
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        itineraryData.value = data.itinerary || {};
                        expenses.value = data.expenses || [];
                        backupSpots.value = data.backups || [];
                        if(data.rate) exchangeRate.value = data.rate;
                    } else {
                        // 如果是第一次使用，建立預設資料結構並寫入
                        syncToCloud();
                    }
                    if(currentTab.value === 'map') updateMapMarkers();
                }, (error) => {
                     // 捕獲錯誤，避免應用程式停止，並將 loading 設為 false
                     console.error("Firebase 連線錯誤或權限被拒絕:", error);
                     loading.value = false;
                });
            }

            const syncToCloud = async () => {
                if (!docRef) return console.warn("Firebase 未初始化，無法同步。");
                try {
                    // 確保行程按時間排序再儲存
                    const dateKey = days[currentDay.value].fullDate;
                    if(itineraryData.value[dateKey]) {
                        itineraryData.value[dateKey].sort((a,b)=>a.time.localeCompare(b.time));
                    }
                    await setDoc(docRef, {
                        itinerary: itineraryData.value,
                        expenses: expenses.value,
                        backups: backupSpots.value,
                        rate: exchangeRate.value
                    }, { merge: true });
                } catch (error) {
                    console.error("寫入 Firebase 失敗:", error);
                }
            };

            // --- 操作邏輯 (與前版相同) ---
            const currentItinerary = computed(() => {
                const dateKey = days[currentDay.value].fullDate;
                return itineraryData.value[dateKey] || [];
            });
            const totalSpentTwd = computed(() => (expenses.value.reduce((a,c)=>a+Number(c.amount),0)*exchangeRate.value).toFixed(0));

            const addItem = () => {
                if(!newItem.value.location) return;
                const dateKey = days[currentDay.value].fullDate;
                if(!itineraryData.value[dateKey]) itineraryData.value[dateKey] = [];
                itineraryData.value[dateKey].push({...newItem.value});
                syncToCloud(); 
                showAddModal.value = false;
                newItem.value = { time: '10:00', location: '', note: '' };
            };
            
            const deleteItem = (idx) => {
                const dateKey = days[currentDay.value].fullDate;
                itineraryData.value[dateKey].splice(idx, 1);
                syncToCloud();
            };

            const addExpense = () => {
                if(!newExpense.value.amount || isNaN(newExpense.value.amount)) return;
                expenses.value.unshift({...newExpense.value, amount: Number(newExpense.value.amount)});
                newExpense.value = {item:'', amount:''};
                syncToCloud();
            };
            const removeExpense = (idx) => { expenses.value.splice(idx,1); syncToCloud(); };
            
            const addBackup = () => { if(newBackup.value){ backupSpots.value.push(newBackup.value); newBackup.value=''; syncToCloud(); }};
            const removeBackup = (idx) => { backupSpots.value.splice(idx,1); syncToCloud(); };
            
            const editRate = () => {
                const newRate = prompt("輸入新的日幣對台幣匯率 (例如 0.21)", exchangeRate.value);
                if(newRate) { exchangeRate.value = parseFloat(newRate); syncToCloud(); }
            };

            const selectDay = (idx) => { currentDay.value = idx; updateMapMarkers(); };
            const switchTab = (tab) => {
                currentTab.value = tab;
                if(tab === 'map') nextTick(() => { 
                    if(!mapInstance.value) initMap(); 
                    else { mapInstance.value.invalidateSize(); updateMapMarkers(); } 
                });
            };

            // 地圖功能 (使用 Leaflet)
            const initMap = () => {
                // 札幌座標
                mapInstance.value = L.map('map').setView([43.0618, 141.3545], 13); 
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(mapInstance.value);
            };
            const updateMapMarkers = () => {
                if(!mapInstance.value) return;
                markers.value.forEach(m => mapInstance.value.removeLayer(m));
                markers.value = [];
                // 簡易模擬座標，實際應用需使用地理編碼 API
                const mockCoords = {'札幌':[43.0618,141.3545], '小樽':[43.1907,140.9947]};
                currentItinerary.value.forEach(item => {
                    let latLng = mockCoords[Object.keys(mockCoords).find(k=>item.location.includes(k))] || [43.0618+(Math.random()-.5)*.05, 141.3545+(Math.random()-.5)*.05];
                    markers.value.push(L.marker(latLng).addTo(mapInstance.value).bindPopup(item.location));
                });
            };
            const locateUser = () => {
                 if (navigator.geolocation) {
                     navigator.geolocation.getCurrentPosition(pos => {
                         L.circleMarker([pos.coords.latitude, pos.coords.longitude], {color:'#3b82f6', radius:8}).addTo(mapInstance.value).bindPopup('我在這！').openPopup();
                         mapInstance.value.setView([pos.coords.latitude, pos.coords.longitude], 15);
                     }, (error) => {
                        console.error("無法取得您的位置:", error);
                     });
                 } else {
                     console.log("瀏覽器不支援地理定位。");
                 }
            };

            return {
                loading, currentTab, currentDay, days, currentItinerary, showAddModal, newItem, exchangeRate, calcJpy, expenses, newExpense, backupSpots, newBackup, totalSpentTwd,
                dbInitialized, // 讓 Vue 能夠顯示 DB 初始化狀態
                switchTab, selectDay, addItem, deleteItem, addExpense, removeExpense, addBackup, removeBackup, editRate, locateUser
            };
        }
    }).mount('#app');
</script>
</body>
</html>
