<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>北海道旅程 (雲端同步版)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'hokkaido-dark': '#1e3a8a',
                        'hokkaido-main': '#3b82f6',
                        'hokkaido-light': '#dbeafe',
                        'hokkaido-bg': '#f8fafc',
                        'accent': '#f43f5e',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { background-color: #e2e8f0; display: flex; justify-content: center; min-height: 100vh; margin: 0; }
        #app-container { width: 100%; max-width: 430px; background-color: #f8fafc; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.1); overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        .glass-nav { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.5); }
        #map { height: 100%; width: 100%; z-index: 0; }
        .loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); z-index: 999; display: flex; justify-content: center; items-center; font-weight: bold; color: #1e3a8a; }
    </style>
</head>
<body>

<div id="app" class="w-full flex justify-center h-full">
    <div id="app-container">
        
        <div v-if="loading" class="loading-overlay">
            <div class="text-center">
                <i class="fa-solid fa-circle-notch fa-spin text-3xl mb-2"></i>
                <p>雲端同步中...</p>
            </div>
        </div>

        <header class="bg-white pt-12 pb-2 px-4 shadow-sm z-20 flex-shrink-0">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold text-hokkaido-dark tracking-wider">HOKKAIDO <span class="text-xs font-normal text-green-500 block"><i class="fa-solid fa-cloud"></i> 線上同步中</span></h1>
                <div class="text-right">
                    <span class="text-xs text-gray-400">匯率 (可點擊修改)</span>
                    <div @click="editRate" class="font-bold text-hokkaido-main text-sm cursor-pointer border-b border-dashed border-blue-300">1 JPY = {{ exchangeRate }} TWD</div>
                </div>
            </div>
            <div class="flex space-x-3 overflow-x-auto hide-scrollbar pb-2">
                <div v-for="(day, index) in days" :key="index" @click="selectDay(index)"
                     class="flex-shrink-0 flex flex-col items-center justify-center w-14 h-16 rounded-2xl transition-all duration-300 cursor-pointer shadow-sm border border-gray-100"
                     :class="currentDay === index ? 'bg-hokkaido-main text-white shadow-lg transform scale-105' : 'bg-white text-gray-400'">
                    <span class="text-xs font-medium">{{ day.weekday }}</span>
                    <span class="text-lg font-bold">{{ day.date }}</span>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto hide-scrollbar bg-hokkaido-bg relative">
            <div v-if="currentTab === 'schedule'" class="p-4 space-y-4 pb-24">
                <div class="bg-gradient-to-r from-hokkaido-main to-hokkaido-dark rounded-3xl p-5 text-white shadow-lg relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 text-8xl opacity-10 text-white"><i class="fa-solid fa-snowflake"></i></div>
                    <div class="flex justify-between items-end relative z-10">
                        <div>
                            <p class="opacity-80 text-sm">今日行程</p>
                            <h2 class="text-3xl font-bold mt-1">北海道之旅</h2>
                            <p class="text-sm mt-2 opacity-90"><i class="fa-solid fa-location-dot mr-1"></i> {{ days[currentDay].fullDate }}</p>
                        </div>
                        <div class="text-right"><div class="text-4xl font-light">-2°<span class="text-lg">C</span></div></div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-gray-700">本日行程</h3>
                        <button @click="showAddModal = true" class="w-8 h-8 rounded-full bg-hokkaido-main text-white shadow-md flex items-center justify-center"><i class="fa-solid fa-plus"></i></button>
                    </div>
                    <div v-if="currentItinerary.length === 0" class="text-center py-10 text-gray-400">
                        <i class="fa-regular fa-calendar-xmark text-4xl mb-2"></i><p>尚無行程</p>
                    </div>
                    <div v-for="(item, idx) in currentItinerary" :key="idx" class="bg-white rounded-2xl p-4 shadow-sm border-l-4 border-hokkaido-main flex gap-4 relative group">
                        <div class="flex flex-col items-center">
                            <span class="text-sm font-bold text-hokkaido-dark">{{ item.time }}</span>
                            <div class="h-full w-0.5 bg-gray-100 mt-1 rounded-full"></div>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800 text-lg">{{ item.location }}</h4>
                            <p class="text-gray-500 text-sm mt-1 bg-gray-50 p-2 rounded-lg" v-if="item.note">{{ item.note }}</p>
                            <button @click="deleteItem(idx)" class="text-xs text-red-400 mt-2 text-right w-full">刪除</button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'map'" class="h-full w-full relative">
                <div id="map"></div>
                <div class="absolute bottom-24 left-4 right-4 bg-white/90 backdrop-blur rounded-xl p-3 shadow-lg z-[400] flex items-center gap-3">
                     <button @click="locateUser" class="bg-hokkaido-dark text-white px-3 py-1.5 rounded-lg text-xs shadow-md ml-auto">我的位置</button>
                </div>
            </div>

            <div v-if="currentTab === 'wallet'" class="p-4 pb-24 space-y-6">
                 <div class="bg-white p-5 rounded-3xl shadow-sm border border-gray-100">
                    <h3 class="text-gray-500 text-sm mb-3">匯率換算 ({{exchangeRate}})</h3>
                    <div class="flex items-center gap-2">
                        <input type="number" v-model="calcJpy" class="w-full bg-gray-50 rounded-xl p-3 text-lg font-bold outline-none" placeholder="JPY">
                        <i class="fa-solid fa-arrow-right text-gray-300"></i>
                        <div class="w-full bg-blue-50/50 rounded-xl p-3 text-lg font-bold text-hokkaido-dark">{{ (calcJpy * exchangeRate).toFixed(0) }} TWD</div>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-3xl shadow-lg border-t-4 border-hokkaido-main">
                    <h3 class="font-bold text-gray-800 mb-4">新增消費</h3>
                    <div class="space-y-3">
                        <input v-model="newExpense.item" type="text" placeholder="項目" class="w-full border-b p-2 outline-none">
                        <div class="flex gap-2">
                            <input v-model="newExpense.amount" type="number" placeholder="日幣" class="flex-1 border-b p-2 outline-none">
                            <button @click="addExpense" class="bg-hokkaido-dark text-white px-6 rounded-xl font-bold">紀錄</button>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="font-bold text-gray-700 mb-3 flex justify-between"><span>明細</span> <span class="text-sm bg-gray-200 px-2 rounded">NT$ {{ totalSpentTwd }}</span></h3>
                    <div v-for="(exp, idx) in expenses" :key="idx" class="flex justify-between items-center bg-white p-3 rounded-xl shadow-sm mb-2">
                        <span>{{ exp.item }}</span>
                        <div class="text-right"><div class="font-bold">¥{{ exp.amount }}</div><button @click="removeExpense(idx)" class="text-xs text-red-400">刪除</button></div>
                    </div>
                </div>
            </div>
            
            <div v-if="currentTab === 'backup'" class="p-4 pb-24">
                <h3 class="font-bold text-gray-800 text-xl mb-4">口袋名單</h3>
                <div class="flex gap-2 mb-4"><input v-model="newBackup" class="flex-1 bg-white p-2 rounded-lg" placeholder="輸入地點"><button @click="addBackup" class="text-hokkaido-main font-bold">新增</button></div>
                <div class="grid grid-cols-2 gap-3">
                    <div v-for="(spot, idx) in backupSpots" :key="idx" class="bg-white p-3 rounded-xl shadow-sm relative">
                        <p class="font-bold text-gray-800">{{ spot }}</p>
                        <button @click="removeBackup(idx)" class="absolute top-2 right-2 text-red-300"><i class="fa-solid fa-times"></i></button>
                    </div>
                </div>
            </div>
        </main>

        <nav class="glass-nav absolute bottom-0 w-full pb-6 pt-3 px-6 flex justify-between items-center z-50 text-gray-400">
            <button @click="switchTab('schedule')" :class="currentTab==='schedule'?'text-hokkaido-dark':''"><i class="fa-solid fa-list-check text-xl"></i></button>
            <button @click="switchTab('map')" :class="currentTab==='map'?'text-hokkaido-dark':''"><i class="fa-solid fa-map-location-dot text-xl"></i></button>
            <div class="relative -top-6"><button @click="showAddModal=true" class="w-14 h-14 bg-hokkaido-dark rounded-full text-white shadow-xl flex items-center justify-center text-xl"><i class="fa-solid fa-plus"></i></button></div>
            <button @click="switchTab('wallet')" :class="currentTab==='wallet'?'text-hokkaido-dark':''"><i class="fa-solid fa-wallet text-xl"></i></button>
            <button @click="switchTab('backup')" :class="currentTab==='backup'?'text-hokkaido-dark':''"><i class="fa-regular fa-bookmark text-xl"></i></button>
        </nav>

        <div v-if="showAddModal" class="absolute inset-0 z-[500] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4">
            <div class="bg-white w-full rounded-3xl p-6 shadow-2xl">
                <h3 class="font-bold text-xl mb-4">新增行程</h3>
                <input v-model="newItem.time" type="time" class="w-full bg-gray-50 p-3 rounded-xl mb-3">
                <input v-model="newItem.location" type="text" placeholder="地點" class="w-full bg-gray-50 p-3 rounded-xl mb-3">
                <textarea v-model="newItem.note" rows="2" placeholder="備註" class="w-full bg-gray-50 p-3 rounded-xl mb-3"></textarea>
                <div class="flex gap-3"><button @click="showAddModal=false" class="flex-1 py-3 bg-gray-100 rounded-xl">取消</button><button @click="addItem" class="flex-1 py-3 bg-hokkaido-dark text-white rounded-xl">確認</button></div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { createApp, ref, computed, nextTick, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ----------------------------------------------------
    // 【請在這裡貼上你的 Firebase Config】
    // ----------------------------------------------------
    const firebaseConfig = {
		  apiKey: "AIzaSyB84uEHzjgOAeO2giyIoOu4Z6G_ZC_Q7FY",
		  authDomain: "hokkaido-trip-552af.firebaseapp.com",
		  projectId: "hokkaido-trip-552af",
		  storageBucket: "hokkaido-trip-552af.firebasestorage.app",
		  messagingSenderId: "143467554118",
		  appId: "1:143467554118:web:ea5e2b1009f4b92d16f147",
		  measurementId: "G-J2W2WGZYVL"
    };
    // ----------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    // 所有的資料都會存在這個 ID 下，大家共享這一份
    const TRIP_DOC_ID = "hokkaido_trip_2025_shared"; 

    createApp({
        setup() {
            const loading = ref(true);
            const currentTab = ref('schedule');
            const currentDay = ref(0);
            const showAddModal = ref(false);
            const exchangeRate = ref(0.21);
            const calcJpy = ref('');
            const mapInstance = ref(null);
            const markers = ref([]);
            
            // 資料結構 (會同步的)
            const itineraryData = ref({});
            const expenses = ref([]);
            const backupSpots = ref(['六花亭', '小樽運河']);

            const days = [
                { weekday: 'Mon', date: '12/23', fullDate: '2024-12-23' },
                { weekday: 'Tue', date: '12/24', fullDate: '2024-12-24' },
                { weekday: 'Wed', date: '12/25', fullDate: '2024-12-25' },
                { weekday: 'Thu', date: '12/26', fullDate: '2024-12-26' },
                { weekday: 'Fri', date: '12/27', fullDate: '2024-12-27' },
                { weekday: 'Sat', date: '12/28', fullDate: '2024-12-28' },
                { weekday: 'Sun', date: '12/29', fullDate: '2024-12-29' },
            ];

            const newItem = ref({ time: '10:00', location: '', note: '' });
            const newExpense = ref({ item: '', amount: '' });
            const newBackup = ref('');

            // --- Firebase 監聽 ---
            // 只要雲端一變，這裡馬上收到更新
            const docRef = doc(db, "trips", TRIP_DOC_ID);
            
            onSnapshot(docRef, (docSnap) => {
                loading.value = false;
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    itineraryData.value = data.itinerary || {};
                    expenses.value = data.expenses || [];
                    backupSpots.value = data.backups || [];
                    if(data.rate) exchangeRate.value = data.rate;
                } else {
                    // 如果是第一次使用，建立預設資料
                    syncToCloud();
                }
                // 更新地圖
                if(currentTab.value === 'map') updateMapMarkers();
            });

            const syncToCloud = async () => {
                await setDoc(docRef, {
                    itinerary: itineraryData.value,
                    expenses: expenses.value,
                    backups: backupSpots.value,
                    rate: exchangeRate.value
                }, { merge: true });
            };

            // --- 操作邏輯 ---
            const currentItinerary = computed(() => {
                const dateKey = days[currentDay.value].fullDate;
                return itineraryData.value[dateKey] || [];
            });
            const totalSpentTwd = computed(() => (expenses.value.reduce((a,c)=>a+Number(c.amount),0)*exchangeRate.value).toFixed(0));

            const addItem = () => {
                if(!newItem.value.location) return;
                const dateKey = days[currentDay.value].fullDate;
                if(!itineraryData.value[dateKey]) itineraryData.value[dateKey] = [];
                itineraryData.value[dateKey].push({...newItem.value});
                itineraryData.value[dateKey].sort((a,b)=>a.time.localeCompare(b.time));
                syncToCloud(); // 儲存到雲端
                showAddModal.value = false;
                newItem.value = { time: '10:00', location: '', note: '' };
            };
            
            const deleteItem = (idx) => {
                const dateKey = days[currentDay.value].fullDate;
                itineraryData.value[dateKey].splice(idx, 1);
                syncToCloud();
            };

            const addExpense = () => {
                if(!newExpense.value.amount) return;
                expenses.value.unshift({...newExpense.value});
                newExpense.value = {item:'', amount:''};
                syncToCloud();
            };
            const removeExpense = (idx) => { expenses.value.splice(idx,1); syncToCloud(); };
            
            const addBackup = () => { if(newBackup.value){ backupSpots.value.push(newBackup.value); newBackup.value=''; syncToCloud(); }};
            const removeBackup = (idx) => { backupSpots.value.splice(idx,1); syncToCloud(); };
            
            const editRate = () => {
                const newRate = prompt("輸入新匯率", exchangeRate.value);
                if(newRate) { exchangeRate.value = parseFloat(newRate); syncToCloud(); }
            };

            const selectDay = (idx) => { currentDay.value = idx; updateMapMarkers(); };
            const switchTab = (tab) => {
                currentTab.value = tab;
                if(tab === 'map') nextTick(() => { if(!mapInstance.value) initMap(); else { mapInstance.value.invalidateSize(); updateMapMarkers(); } });
            };

            // 地圖功能簡化版
            const initMap = () => {
                mapInstance.value = L.map('map').setView([43.0618, 141.3545], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(mapInstance.value);
            };
            const updateMapMarkers = () => {
                if(!mapInstance.value) return;
                markers.value.forEach(m => mapInstance.value.removeLayer(m));
                markers.value = [];
                const mockCoords = {'札幌':[43.0618,141.3545], '小樽':[43.1907,140.9947]}; // 簡化示範
                currentItinerary.value.forEach(item => {
                    // 簡易模擬座標，實際專案需接 API
                    let latLng = mockCoords[Object.keys(mockCoords).find(k=>item.location.includes(k))] || [43.0618+(Math.random()-.5)*.05, 141.3545+(Math.random()-.5)*.05];
                    markers.value.push(L.marker(latLng).addTo(mapInstance.value).bindPopup(item.location));
                });
            };
            const locateUser = () => {
                 navigator.geolocation.getCurrentPosition(pos => {
                     L.circleMarker([pos.coords.latitude, pos.coords.longitude], {color:'#3b82f6', radius:8}).addTo(mapInstance.value).bindPopup('我').openPopup();
                     mapInstance.value.setView([pos.coords.latitude, pos.coords.longitude], 15);
                 });
            };

            return {
                loading, currentTab, currentDay, days, currentItinerary, showAddModal, newItem, exchangeRate, calcJpy, expenses, newExpense, backupSpots, newBackup, totalSpentTwd,
                switchTab, selectDay, addItem, deleteItem, addExpense, removeExpense, addBackup, removeBackup, editRate, locateUser
            };
        }
    }).mount('#app');
</script>
</body>
</html>